<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carga de Pintura</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .view-selector {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .view-option {
            display: flex;
            align-items: center;
            margin-left: 15px;
            cursor: pointer;
        }

        .view-option input {
            margin-right: 5px;
            cursor: pointer;
        }

        .view-option label {
            cursor: pointer;
            margin: 0;
        }

        .esmalte-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .esmalte-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4a6cf7;
        }

        .esmalte-card h4 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }

        .esmalte-card p {
            margin: 5px 0;
            color: #4a5568;
        }

        .hidden {
            display: none;
        }

        .envases-container {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .envase-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }

        .envase-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-content-grid">
        <div class="form-section card">
            <div class="header-controls">
                <h2>Crear Carga</h2>
                <div class="mode-selector">
                    <button id="modeVinilica" class="active">Pintura Vinílica</button>
                    <button id="modeEsmalte">Pintura de Esmalte</button>
                </div>
            </div>

            <form id="formCarga">
                <div class="input-group">
                    <label for="codigo">Código de Pintura</label>
                    <input type="text" id="codigo" required />
                </div>

                <!-- SECCIÓN DE ENVASES DISPONIBLES -->
                <div id="envasesDisponiblesContainer" class="envases-container" style="display: none;">
                    <h4>Envases Disponibles</h4>
                    <div id="envasesList"></div>
                </div>

                <fieldset>
                    <legend>Distribución</legend>
                    <div class="distribution-inputs">
                        <div class="input-group">
                            <label for="medios">Medios (0.5 L)</label>
                            <input type="number" id="medios" min="0" value="0" />
                        </div>
                        <div class="input-group">
                            <label for="litros">Litros (1 L)</label>
                            <input type="number" id="litros" min="0" value="0" />
                        </div>
                        <div class="input-group">
                            <label for="galones">Galones (4 L)</label>
                            <input type="number" id="galones" min="0" value="0" />
                        </div>
                        <div class="input-group">
                            <label for="cubetas">Cubetas (19 L)</label>
                            <input type="number" id="cubetas" min="0" value="0" />
                        </div>
                    </div>
                    <p class="total-litros">Total de litros: <span id="totalDistribucion">0</span> L</p>
                </fieldset>

                <div class="form-buttons">
                    <button type="submit" class="button-primary">Agregar Carga</button>
                    <button type="button" id="verCargas" class="button-secondary">Lista de Cargas</button>
                    <button type="button" id="btnRecomendar" class="button-secondary">Recomendar Programación</button>
                    <button type="button" id="guardarEnBD" class="button-success">
                        <i class="fas fa-database"></i> Guardar en BD
                    </button>
                </div>
                <p id="mensaje"></p>
            </form>
        </div>

        <div class="right-column">
            <div id="infoProducto" class="info-box card" style="display:none;">
                <h3>Información del Producto</h3>
                <div class="product-info-line">
                    <p><strong>Descripción:</strong> <span id="descProducto"></span></p>
                    <p><strong>Categoría:</strong> <span id="categoriaProducto"></span></p>
                    <p><strong>Prioridad:</strong> <span id="prioridadProducto"></span></p>
                </div>
            </div>

            <div class="view-selector">
                <div class="view-option">
                    <input type="radio" id="viewTable" name="viewOption" value="table" checked>
                    <label for="viewTable">Arriba (Tabla)</label>
                </div>
                <div class="view-option">
                    <input type="radio" id="viewCards" name="viewOption" value="cards">
                    <label for="viewCards">Abajo (Cards)</label>
                </div>
            </div>

            <div id="distributionTableSection" class="distribution-section card">
                <h3>Vista previa distribución</h3>
                <div class="table-container">
                    <table id="tablaDistribucion">
                        <thead>
                            <tr>
                                <th>Unidad</th>
                                <th>Cantidad</th>
                                <th>Litros</th>
                                <th>Total (L)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Medios</td>
                                <td id="cantMedios">0</td>
                                <td>0.5</td>
                                <td id="litrosMedios">0</td>
                            </tr>
                            <tr>
                                <td>Litros</td>
                                <td id="cantLitros">0</td>
                                <td>1</td>
                                <td id="litrosLitros">0</td>
                            </tr>
                            <tr>
                                <td>Galones</td>
                                <td id="cantGalones">0</td>
                                <td>4</td>
                                <td id="litrosGalones">0</td>
                            </tr>
                            <tr>
                                <td>Cubetas</td>
                                <td id="cantCubetas">0</td>
                                <td>19</td>
                                <td id="litrosCubetas">0</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="3" style="text-align: right;">Total</td>
                                <td id="litrosTotalTabla">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="vinilicaMode">
        <div id="tablaRondas" class="tabla-rondas card"></div>
        <div class="footer-buttons">
            <button id="exportarOrdenes" class="button-tertiary">Subrayar a Ordenes</button>
            <button id="exportarVinilicas" class="button-tertiary">
                Exportar reporte de producción
            </button>
        </div>
    </div>

    <div id="esmalteMode" style="display: none;">
        <div class="esmalte-content">
            <h3>Cargas de Esmalte</h3>
            <div id="esmalte-cards-container"></div>
        </div>
    </div>
</div>

<!-- MODALES -->
<div id="modalCargas" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Lista de Cargas</h2>
            <span class="close-button" id="closeModal">&times;</span>
        </div>
        <div class="modal-body">
            <div class="table-container-modal">
                <table id="cargasTable">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Código</th>
                            <th>Base</th>
                            <th>Litros</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button id="btnAsignarRondas" class="button-primary">Asignar Rondas</button>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visualmente-oculto">Cargando...</span>
    </div>
    <span class="ms-2">Guardando en base de datos...</span>
</div>

<script>
// ====== CONFIGURACIÓN DE API ======
const API_BASE_URL = 'https://pintumexplaneacion-1.onrender.com';

// ====== Configuración inicial ======
const categoriasPrioridad = {
    "Transparentes": 1, "Basicos": 2, "Basicos 1": 3, "Basicos 2": 4, "Unica": 5, "Base Nueva": 6, "Intensos 1": 7,
    "Intensos": 8, "Intensos 2": 9, "Medios": 10, "Pastel": 11, "Tonos": 12, "Pastel 1": 13, "Pastel 2": 14,
    "Blancos": 15, "Directos": 16,
    "Esmalux SR": 1, "DryLux SR": 2, "Automotive": 3, "Base Transparente": 4, "Base Blanca": 5, "Base Pastel": 6,
    "Base Media": 7, "Base Intensa": 8, "Igualacion": 9
};

let cargasGuardadas = [];

// ====== Variables DOM ======
const codigoInput = document.getElementById('codigo');
const descSpan = document.getElementById('descProducto');
const categoriaSpan = document.getElementById('categoriaProducto');
const prioridadSpan = document.getElementById('prioridadProducto');
const infoDiv = document.getElementById('infoProducto');
const mensaje = document.getElementById('mensaje');
const mediosInput = document.getElementById('medios');
const litrosInput = document.getElementById('litros');
const galonesInput = document.getElementById('galones');
const cubetasInput = document.getElementById('cubetas');
const envasesContainer = document.getElementById('envasesDisponiblesContainer');
const envasesList = document.getElementById('envasesList');

// ====== FUNCIONES PRINCIPALES ======
async function buscarProductoPorCodigo(codigo) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/productos/codigo/${encodeURIComponent(codigo)}`);
        if (!response.ok) {
            if (response.status === 404) return null;
            throw new Error(`Error en la búsqueda: ${response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        console.error("Error al buscar producto:", error);
        return null;
    }
}

async function cargarProductoPorCodigo() {
    const codigo = codigoInput.value.trim();
    if (!codigo) {
        infoDiv.style.display = 'none';
        envasesContainer.style.display = 'none';
        return null;
    }

    const producto = await buscarProductoPorCodigo(codigo);
    if (producto) {
        // Mostrar información del producto
        descSpan.textContent = producto.descripcion;
        categoriaSpan.textContent = producto.categoria.nombre;
        prioridadSpan.textContent = producto.categoria.prioridad;
        infoDiv.style.display = 'block';

        // Mostrar envases disponibles (aunque cantidad sea null)
        mostrarEnvasesDisponibles(producto.envasesDisponibles);
        
        mensaje.textContent = '';
        return producto;
    } else {
        infoDiv.style.display = 'none';
        envasesContainer.style.display = 'none';
        mensaje.style.color = 'red';
        mensaje.textContent = 'Código no encontrado.';
        return null;
    }
}

function mostrarEnvasesDisponibles(envases) {
    envasesList.innerHTML = '';
    
    if (envases && envases.length > 0) {
        envasesContainer.style.display = 'block';
        
        envases.forEach(envase => {
            const envaseItem = document.createElement('div');
            envaseItem.className = 'envase-item';
            
            // Mostrar el envase aunque cantidadDisponible sea null
            const cantidad = envase.cantidadDisponible !== null ? envase.cantidadDisponible : 'Disponible';
            envaseItem.innerHTML = `
                <span>${envase.envase.tipo} (${envase.envase.capacidad}L)</span>
                <span>${cantidad}</span>
            `;
            envasesList.appendChild(envaseItem);
        });
    } else {
        envasesContainer.style.display = 'none';
    }
}

function actualizarDistribucion() {
    const medios = Number(mediosInput.value) || 0;
    const litros = Number(litrosInput.value) || 0;
    const galones = Number(galonesInput.value) || 0;
    const cubetas = Number(cubetasInput.value) || 0;
    const totalLitros = (medios * 0.5) + litros + (galones * 4) + (cubetas * 19);

    document.getElementById('totalDistribucion').textContent = totalLitros.toFixed(2);
    document.getElementById('litrosTotalTabla').textContent = totalLitros.toFixed(2);
    return totalLitros;
}

// ====== EVENT LISTENERS ======
document.addEventListener('DOMContentLoaded', function() {
    // Cargar estado inicial
    const savedCargas = localStorage.getItem('cargasGuardadas');
    if (savedCargas) {
        cargasGuardadas = JSON.parse(savedCargas);
    }

    // Event listeners
    codigoInput.addEventListener('blur', cargarProductoPorCodigo);
    
    [mediosInput, litrosInput, galonesInput, cubetasInput].forEach(input => {
        input.addEventListener('input', actualizarDistribucion);
    });

    // Submit del formulario
    document.getElementById('formCarga').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const codigo = codigoInput.value.trim();
        const producto = await cargarProductoPorCodigo();
        
        if (producto) {
            const totalLitros = actualizarDistribucion();
            if (totalLitros > 0) {
                // Aquí tu lógica para guardar la carga
                mensaje.style.color = 'green';
                mensaje.textContent = 'Carga agregada correctamente!';
            }
        }
    });
});

// ====== FUNCIONES DE MODAL ======
document.getElementById('verCargas').addEventListener('click', function() {
    // Lógica para mostrar cargas
    console.log('Mostrar cargas guardadas');
});

document.getElementById('closeModal').addEventListener('click', function() {
    document.getElementById('modalCargas').style.display = 'none';
});

// ====== FUNCIONES AUXILIARES ======
function guardarEstado() {
    localStorage.setItem('cargasGuardadas', JSON.stringify(cargasGuardadas));
}

function mostrarNotificacion(mensaje, tipo) {
    const notification = document.createElement('div');
    notification.className = `notification ${tipo}`;
    notification.textContent = mensaje;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
</body>
</html>