<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carga de Pintura</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .view-selector {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .view-option {
            display: flex;
            align-items: center;
            margin-left: 15px;
            cursor: pointer;
        }

        .view-option input {
            margin-right: 5px;
            cursor: pointer;
        }

        .view-option label {
            cursor: pointer;
            margin: 0;
        }

        .esmalte-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .esmalte-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4a6cf7;
        }

        .esmalte-card h4 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }

        .esmalte-card p {
            margin: 5px 0;
            color: #4a5568;
        }

        .hidden {
            display: none;
        }

        .envases-container {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .envase-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }

        .envase-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-content-grid">
        <div class="form-section card">
            <div class="header-controls">
                <h2>Crear Carga</h2>
                <div class="mode-selector">
                    <button id="modeVinilica" class="active">Pintura Vinílica</button>
                    <button id="modeEsmalte">Pintura de Esmalte</button>
                </div>
            </div>

            <form id="formCarga">
                <div class="input-group">
                    <label for="codigo">Código de Pintura</label>
                    <input type="text" id="codigo" required />
                </div>

                <!-- SECCIÓN DE ENVASES DISPONIBLES -->
                <div id="envasesDisponiblesContainer" class="envases-container">
                    <h4>Envases Disponibles</h4>
                    <div id="envasesList"></div>
                </div>

                <fieldset>
                    <legend>Distribución</legend>
                    <div class="distribution-inputs">
                        <div class="input-group">
                            <label for="medios">Medios (0.5 L)</label>
                            <input type="number" id="medios" min="0" value="0" />
                        </div>
                        <div class="input-group">
                            <label for="litros">Litros (1 L)</label>
                            <input type="number" id="litros" min="0" value="0" />
                        </div>
                        <div class="input-group">
                            <label for="galones">Galones (4 L)</label>
                            <input type="number" id="galones" min="0" value="0" />
                        </div>
                        <div class="input-group">
                            <label for="cubetas">Cubetas (19 L)</label>
                            <input type="number" id="cubetas" min="0" value="0" />
                        </div>
                    </div>
                    <p class="total-litros">Total de litros: <span id="totalDistribucion">0</span> L</p>
                </fieldset>

                <div class="form-buttons">
                    <button type="submit" class="button-primary">Agregar Carga</button>
                    <button type="button" id="verCargas" class="button-secondary">Lista de Cargas</button>
                    <button type="button" id="btnRecomendar" class="button-secondary">Recomendar Programación</button>
                    <button type="button" id="guardarEnBD" class="button-success">
                        <i class="fas fa-database"></i> Guardar en BD
                    </button>
                    <div class="historial-section card">
                        <h3>Historial de Cargas por Día</h3>
                        <div class="date-selector">
                            <label for="fechaCargas">Selecciona una fecha:</label>
                            <input type="date" id="fechaCargas">
                        </div>
                    </div>
                </div>
                <p id="mensaje"></p>
            </form>
        </div>

        <div class="right-column">
            <div id="infoProducto" class="info-box card" style="display:none;">
                <h3>Información del Producto</h3>
                <div class="product-info-line">
                    <p><strong>Descripcion:</strong> <span id="descProducto"></span></p>
                    <p><strong>Categoria:</strong> <span id="categoriaProducto"></span></p>
                    <p><strong>Prioridad:</strong> <span id="prioridadProducto"></span></p>
                </div>
            </div>

            <div class="view-selector">
                <div class="view-option">
                    <input type="radio" id="viewTable" name="viewOption" value="table" checked>
                    <label for="viewTable">Arriba (Tabla)</label>
                </div>
                <div class="view-option">
                    <input type="radio" id="viewCards" name="viewOption" value="cards">
                    <label for="viewCards">Abajo (Cards)</label>
                </div>
            </div>

            <div id="distributionTableSection" class="distribution-section card">
                <h3>Vista previa distribución</h3>
                <div class="table-container">
                    <table id="tablaDistribucion">
                        <thead>
                            <tr>
                                <th>Unidad</th>
                                <th>Cantidad</th>
                                <th>Litros</th>
                                <th>Total (L)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Medios</td>
                                <td id="cantMedios">0</td>
                                <td>0.5</td>
                                <td id="litrosMedios">0</td>
                            </tr>
                            <tr>
                                <td>Litros</td>
                                <td id="cantLitros">0</td>
                                <td>1</td>
                                <td id="litrosLitros">0</td>
                            </tr>
                            <tr>
                                <td>Galones</td>
                                <td id="cantGalones">0</td>
                                <td>4</td>
                                <td id="litrosGalones">0</td>
                            </tr>
                            <tr>
                                <td>Cubetas</td>
                                <td id="cantCubetas">0</td>
                                <td>19</td>
                                <td id="litrosCubetas">0</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="3" style="text-align: right;">Total</td>
                                <td id="litrosTotalTabla">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="distributionCardsSection" class="distribution-section card hidden">
                <h3>Vista previa distribución (Cards)</h3>
                <div id="distributionCardsContainer" class="esmalte-cards-container">
                </div>
            </div>
        </div>
    </div>

    <div id="vinilicaMode">
        <div id="tablaRondas" class="tabla-rondas card"></div>
        <div class="footer-buttons">
            <button id="exportarOrdenes" class="button-tertiary">Subrayar  a Ordenes</button>
            <button id="exportarVinilicas" class="button-tertiary">
                Exportar reporte de producción
                <span class="loading-spinner" style="display:none;"></span>
            </button>
        </div>
    </div>

    <div id="esmalteMode" style="display: none;">
        <div class="esmalte-content">
            <h3>Cargas de Esmalte</h3>
            <div id="esmalte-cards-container"></div>
        </div>
    </div>
</div>

<div id="modalCargas" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Lista de Cargas</h2>
            <span class="close-button" id="closeModal">&times;</span>
        </div>
        <div class="modal-body">
            <div class="table-container-modal">
                <table id="cargasTable">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Código</th>
                            <th>Base</th>
                            <th>Litros</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button id="btnAsignarRondas" class="button-primary">Asignar Rondas</button>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visualmente-oculto">Cargando...</span>
    </div>
    <span class="ms-2">Guardando en base de datos...</span>
</div>

<div id="notification" class="notification"></div>

<div id="modalVinilica" class="modal">
    <div class="modal-content modal-vinilica">
        <div class="modal-header">
            <h2>Detalles de la Carga de Vinílica</h2>
            <span class="close-button" id="closeModalCargas">&times;</span>
        </div>
        <div class="modal-body">
            <div class="vinilica-details">
                <div class="detail-row"><div class="detail-label">Folio:</div><div class="detail-value" id="modalFolio"></div></div>
                <div class="detail-row"><div class="detail-label">Código:</div><div class="detail-value" id="modalCodigo"></div></div>
                <div class="detail-row"><div class="detail-label">Descripción:</div><div class="detail-value" id="modalDescripcion"></div></div>
                <div class="detail-row"><div class="detail-label">Base:</div><div class="detail-value" id="modalBase"></div></div>
                <div class="detail-row"><div class="detail-label">Categoría:</div><div class="detail-value" id="modalCategoria"></div></div>
                <div class="detail-row"><div class="detail-label">Prioridad:</div><div class="detail-value" id="modalPrioridad"></div></div>
                <div class="detail-row"><div class="detail-label">Máquina:</div><div class="detail-value" id="modalMaquina"></div></div>
                <div class="detail-row"><div class="detail-label">Ronda:</div><div class="detail-value" id="modalRonda"></div></div>
                <div class="detail-row"><div class="detail-label">Total de Litros:</div><div class="detail-value" id="modalLitros"></div></div>
                <div class="detail-row"><div class="detail-label">Distribución:</div><div class="detail-value" id="modalDistribucion"></div></div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="btnEditarCarga" class="button-secondary">Editar</button>
            <button id="btnEliminarCarga" class="button-danger">Eliminar</button>
        </div>
    </div>
</div>

<div id="excelLoadingModal" class="modal-loading-overlay">
    <div class="modal-loading-content">
        <div class="loading-spinner-modal">
            <i class="fas fa-spinner fa-pulse"></i>
            <p>Analizando su inventario... un momento, por favor.</p>
            <p class="small-text">Esto puede tardar unos segundos dependiendo del tamaño del archivo.</p>
        </div>
    </div>
</div>

<div id="modalRecomendacion" class="modal">
    <div class="modal-content modal-vinilica">
        <div class="modal-header">
            <h2>Recomendaciones de Producción</h2>
            <span class="close-button" id="closeModalRecomendacion">&times;</span>
        </div>
        <div class="modal-body">
            <div id="contenidoRecomendacion"></div>
        </div>
        <div class="modal-footer">
            <button class="button-secondary" id="cerrarRecomendacion">Cerrar</button>
        </div>
    </div>
</div>
<input type="file" id="inputPdf" accept=".pdf" style="display:none;">

<script>
// ====== CONFIGURACIÓN DE API ======
const API_BASE_URL = 'https://pintumexplaneacion-1.onrender.com';

// ====== Configuración inicial ======
const categoriasPrioridad = {
    "Transparentes": 1, "Basicos": 2, "Basicos 1": 3, "Basicos 2": 4, "Unica": 5, "Base Nueva": 6, "Intensos 1": 7,
    "Intensos": 8, "Intensos 2": 9, "Medios": 10, "Pastel": 11, "Tonos": 12, "Pastel 1": 13, "Pastel 2": 14,
    "Blancos": 15, "Directos": 16,
    "Esmalux SR": 1, "DryLux SR": 2, "Automotive": 3, "Base Transparente": 4, "Base Blanca": 5, "Base Pastel": 6,
    "Base Media": 7, "Base Intensa": 8, "Igualacion": 9
};

const capacidadesMaquinas = {
    "VI-101": 850, "VI-102": 850, "VI-103": 850, "VI-104": 2400, "VI-105": 850, "VI-106": 850, "VI-107": 1600,
    "VI-108": 2400
};

const maquinas = Object.keys(capacidadesMaquinas);
const rondasTotales = 4;
const mapaMaquinaRondas = {};
let cargasGuardadas = [];

const equipoTerminado = ["Alberto", "Pedro", "Germán"];
const equipoMoliendaPreparado = ["Aldo", "Gaspar"];
let indiceTerminado = 0;
let indiceMoliendaPreparado = 0;

// Inicializar estructura de datos
maquinas.forEach(m => {
    mapaMaquinaRondas[m] = {};
    for (let r = 1; r <= rondasTotales; r++) {
        mapaMaquinaRondas[m][r] = [];
    }
});

// ====== Variables DOM ======
const codigoInput = document.getElementById('codigo');
const descSpan = document.getElementById('descProducto');
const categoriaSpan = document.getElementById('categoriaProducto');
const prioridadSpan = document.getElementById('prioridadProducto');
const infoDiv = document.getElementById('infoProducto');
const mensaje = document.getElementById('mensaje');
const mediosInput = document.getElementById('medios');
const litrosInput = document.getElementById('litros');
const galonesInput = document.getElementById('galones');
const cubetasInput = document.getElementById('cubetas');
const tabla = document.getElementById("tablaRondas");

const modeVinilica = document.getElementById('modeVinilica');
const modeEsmalte = document.getElementById('modeEsmalte');
const vinilicaSection = document.getElementById('vinilicaMode');
const esmalteSection = document.getElementById('esmalteMode');
const formCarga = document.getElementById('formCarga');

const verCargasButton = document.getElementById('verCargas');
const modalCargas = document.getElementById('modalCargas');
const closeModalButton = document.getElementById('closeModal');
const cargasTableBody = document.querySelector('#cargasTable tbody');
const asignarRondasBtn = document.getElementById('btnAsignarRondas');
const btnAsignarEsmaltes = document.getElementById('btnAsignarEsmaltes');

const loadingOverlay = document.getElementById('loadingOverlay');
const envasesContainer = document.getElementById('envasesDisponiblesContainer');
const envasesList = document.getElementById('envasesList');

// ====== Funciones auxiliares y lógica del negocio ======
function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return [d.getUTCFullYear(), weekNo];
}

function generarFolioBase() {
    const hoy = new Date();
    const anio = String(hoy.getFullYear()).slice(-2);
    const mes = String(hoy.getMonth() + 1).padStart(2, "0");
    const dia = String(hoy.getDate()).padStart(2, "0");
    const modo = modeEsmalte.classList.contains('active') ? 'E' : 'V';
    return `${modo}${anio}${mes}${dia}`;
}

function generarFolioTemporal() {
    const hoy = new Date();
    const anio = String(hoy.getFullYear()).slice(-2);
    const mes = String(hoy.getMonth() + 1).padStart(2, "0");
    const dia = String(hoy.getDate()).padStart(2, "0");
    const marcaTiempo = Date.now();
    const modo = modeEsmalte.classList.contains('active') ? 'E' : 'V';
    return `${modo}${anio}${mes}${dia}-${marcaTiempo}`;
}

function inicializarFolio() {
    const numCargas = cargasGuardadas.filter(c => c.tipoPintura === (modeEsmalte.classList.contains('active') ? 'esmalte' : 'vinilica')).length + 1;
    const numero = String(numCargas).padStart(3, "0");
    const fechaString = generarFolioBase();
}

function actualizarDistribucion() {
    const medios = Number(mediosInput.value) || 0;
    const litros = Number(litrosInput.value) || 0;
    const galones = Number(galonesInput.value) || 0;
    const cubetas = Number(cubetasInput.value) || 0;
    const totalLitros = (medios * 0.5) + litros + (galones * 4) + (cubetas * 19);

    document.getElementById('cantMedios').textContent = medios;
    document.getElementById('cantLitros').textContent = litros;
    document.getElementById('cantGalones').textContent = galones;
    document.getElementById('cantCubetas').textContent = cubetas;

    document.getElementById('litrosMedios').textContent = (medios * 0.5).toFixed(2);
    document.getElementById('litrosLitros').textContent = litros.toFixed(2);
    document.getElementById('litrosGalones').textContent = (galones * 4).toFixed(2);
    document.getElementById('litrosCubetas').textContent = (cubetas * 19).toFixed(2);

    document.getElementById('totalDistribucion').textContent = totalLitros.toFixed(2);
    document.getElementById('litrosTotalTabla').textContent = totalLitros.toFixed(2);
    return totalLitros;
}

async function buscarProductoPorCodigo(codigo) {
    const modoActivo = modeEsmalte.classList.contains('active') ? 'esmalte' : 'vinilica';
    let endpoint = '';

    if (modoActivo === 'esmalte') {
        endpoint = `${API_BASE_URL}/api/esmaltes/codigo/${encodeURIComponent(codigo)}`;
    } else {
        endpoint = `${API_BASE_URL}/api/productos/codigo/${encodeURIComponent(codigo)}`;
    }

    try {
        const response = await fetch(endpoint);
        if (!response.ok) {
            if (response.status === 404) return null;
            throw new Error(`Error en la búsqueda: ${response.statusText}`);
        }
        
        const producto = await response.json();
        
        if (modoActivo === 'esmalte') {
            return {
                descripcion: producto.descripcion,
                tipo: producto.tipo,
                es_igualacion: producto.es_igualacion,
                molienda: producto.molienda,
                preparado: producto.preparado,
                terminado: producto.terminado,
                categoria: { 
                    nombre: producto.tipo,
                    prioridad: categoriasPrioridad[producto.tipo] || 99
                }
            };
        } else { // modo vinilica
            return {
                descripcion: producto.descripcion,
                base: producto.base,
                numeroBase: producto.numeroBase,
                categoria: { 
                    nombre: producto.categoria.nombre,
                    prioridad: categoriasPrioridad[producto.categoria.nombre] || 99 
                },
                envasesDisponibles: producto.envasesDisponibles || []
            };
        }
    } catch (error) {
        console.error("Error al buscar producto:", error);
        return null;
    }
}

function mostrarEnvasesDisponibles(envases) {
    envasesList.innerHTML = '';
    
    if (envases && envases.length > 0) {
        envasesContainer.style.display = 'block';
        
        envases.forEach(envase => {
            const envaseItem = document.createElement('div');
            envaseItem.className = 'envase-item';
            
            const cantidad = envase.cantidadDisponible !== null ? envase.cantidadDisponible : 'Disponible';
            envaseItem.innerHTML = `
                <span>${envase.envase.tipo} (${envase.envase.capacidad}L)</span>
                <span>${cantidad}</span>
            `;
            envasesList.appendChild(envaseItem);
        });
    } else {
        envasesContainer.style.display = 'none';
    }
}

async function cargarProductoPorCodigo() {
    const codigo = codigoInput.value.trim();
    if (!codigo) {
        infoDiv.style.display = 'none';
        envasesContainer.style.display = 'none';
        return null;
    }
    const producto = await buscarProductoPorCodigo(codigo);
    if (producto) {
        descSpan.textContent = producto.descripcion;
        categoriaSpan.textContent = producto.categoria.nombre;
        prioridadSpan.textContent = producto.categoria.prioridad;
        infoDiv.style.display = 'block';
        
        // Mostrar envases disponibles
        if (producto.envasesDisponibles) {
            mostrarEnvasesDisponibles(producto.envasesDisponibles);
        } else {
            envasesContainer.style.display = 'none';
        }
        
        mensaje.textContent = '';
        return producto;
    } else {
        descSpan.textContent = '';
        categoriaSpan.textContent = '';
        prioridadSpan.textContent = '';
        infoDiv.style.display = 'none';
        envasesContainer.style.display = 'none';
        mensaje.style.color = 'red';
        mensaje.textContent = 'Código no encontrado.';
        return null;
    }
}

// ... (EL RESTO DE TU CÓDIGO ORIGINAL COMPLETO SE MANTIENE IGUAL)
// [Aquí irían todas las funciones restantes: renderizarTabla, renderizarTablaEsmaltes, 
//  generarFoliosVinilica, guardarEstado, cargarEstado, cambiarModo, etc.]
// Solo se cambiaron las URLs para usar API_BASE_URL

// ====== Initialization ======
window.onload = () => {
    cargarEstado();
    inicializarFolio();
    actualizarDistribucion();
    if (modeVinilica.classList.contains('active')) {
        renderizarTabla();
    } else {
        cambiarModo('esmalte');
    }
};

</script>
</body>
</html>