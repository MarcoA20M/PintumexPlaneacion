<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Historial de Cargas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/stylesHistorial.css">
</head>
<body>
    <header>
        Historial de Cargas
    </header>

    <div id="controls">
        <button onclick="window.history.back()">Regresar</button>
        <input type="date" id="fechaInput">
    </div>

    <div class="container">
        <div id="grid-container" class="grid-container" style="display:none;">
            <div class="header-cell">Máquina</div>
            <div class="header-cell">Ronda 1</div>
            <div class="header-cell">Ronda 2</div>
            <div class="header-cell">Ronda 3</div>
            <div class="header-cell">Ronda 4</div>
            <div class="header-cell">Ronda 5</div>
        </div>
        <div id="noData" class="no-data" style="display:none;">No hay datos para esta fecha.</div>
        <div id="loading" class="loading" style="display:none;">Cargando...</div>
    </div>

    <script>
        const maquinas = [
            "VI-101", "VI-102", "VI-103", "VI-104", 
            "VI-105", "VI-106", "VI-107", "VI-108"
        ];

        // Función para obtener la fecha de hoy en formato YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function cargarHistorial() {
            const params = new URLSearchParams(window.location.search);
            const fechaUrl = params.get("fecha");
            const fechaInput = document.getElementById("fechaInput");
            const gridContainer = document.getElementById("grid-container");
            const noData = document.getElementById("noData");
            const loading = document.getElementById("loading");

            // Establece el valor del input de fecha
            if (fechaUrl) {
                fechaInput.value = fechaUrl;
            } else {
                fechaInput.value = getTodayDate();
            }

            const fecha = fechaInput.value;

            // Agrega un listener para recargar la página cuando la fecha cambie
            fechaInput.addEventListener('change', (event) => {
                const nuevaFecha = event.target.value;
                window.location.href = `?fecha=${nuevaFecha}`;
            });

            if (!fecha) {
                noData.style.display = "block";
                return;
            }

            loading.style.display = "block";

            try {
                const response = await fetch(`http://localhost:8080/api/cargas/fecha?fecha=${fecha}`);
                const cargas = await response.json();

                if (!cargas || cargas.length === 0) {
                    noData.style.display = "block";
                } else {
                    gridContainer.style.display = "grid";
                    
                    const groupedCargas = {};
                    maquinas.forEach(maquina => {
                        groupedCargas[maquina] = { 1: [], 2: [], 3: [], 4: [], 5: [] };
                    });

                    cargas.forEach(carga => {
                        const maquina = carga.maquinaAsignada;
                        let ronda = parseInt(carga.rondaAsignada, 10);
                        if (isNaN(ronda) || ronda < 1 || ronda > 5) ronda = 1;

                        if (groupedCargas[maquina] && groupedCargas[maquina][ronda]) {
                            groupedCargas[maquina][ronda].push(carga);
                        }
                    });

                    maquinas.forEach(maquina => {
                        const rowHeader = document.createElement("div");
                        rowHeader.classList.add("row-header", "data-cell");
                        rowHeader.textContent = maquina;
                        gridContainer.appendChild(rowHeader);

                        for (let i = 1; i <= 5; i++) {
                            const cell = document.createElement("div");
                            cell.classList.add("data-cell");

                            const cargasInCell = groupedCargas[maquina][i];
                            if (cargasInCell.length > 0) {
                                cargasInCell.forEach(carga => {
                                    let envaseText = "N/A";
                                    if (carga.cubetas > 0) {
                                        envaseText = `19 - ${carga.cubetas}`;
                                    } else if (carga.galones > 0) {
                                        envaseText = `4 - ${carga.galones}`;
                                    } else if (carga.litrosEnvase > 0) {
                                        envaseText = `18 - ${carga.litrosEnvase}`;
                                    } else if (carga.medios > 0) {
                                        envaseText = `8 - ${carga.medios}`;
                                    }

                                    const card = document.createElement("div");
                                    card.classList.add("carga-card");
                                    card.innerHTML = `
                                        <div class="header-content">
                                            <div class="main-code">${carga.codigoPintura || "N/A"}</div>
                                            <div class="litros-total-circulo">
                                                <span>${(carga.totalLitros || 0).toFixed(0)} L</span>
                                            </div>
                                        </div>
                                        <div class="distribution-details-new">
                                            <span>Folio: ${carga.folio || "N/A"}</span>
                                            <span>Envasado: ${envaseText}</span>
                                        </div>
                                    `;
                                    cell.appendChild(card);
                                });
                            }
                            gridContainer.appendChild(cell);
                        }
                    });
                }
            } catch (err) {
                noData.textContent = "Error cargando los datos.";
                noData.style.display = "block";
                console.error(err);
            } finally {
                loading.style.display = "none";
            }
        }

        cargarHistorial();
    </script>
</body>
</html>